#!/data/data/com.termux/files/usr/bin/bash
# WRAPPER: IMPORTANT DON'T CHANGE ANYTHING HERE    #[ -z "$BASH_VERSION" ] && exec bash "$0" "$@"
# shellcheck disable=SC1090
#
SETXVGLOBAL=
PACKAGE="nene"
VERSION="1.6.7-unstable"
SUMMARY="Nene is both a static site and a set of Bash tools you can run straight from your terminal"
NEPI="https://not-echo-not-true.carrd.co" # formerly not-echo-not-true.carrd.co
V_FLAGS='--version' # GLOBAL FLAGS
E_MATCH='--exact' # FZF FLAGS
S_MATCH='--smart'
UNKNOWN="Error: Unknown options"
STARGS=1;
NDARGS=2;
RDARGS=3;
THARGS=4;
NULLARGS=0;
FZF_DEFAULT_OPTS=
# FZF_DEFAULT_OPTS="--height=40% --layout=reverse --info=inline --border --margin=1 --padding=1"
GLOBAL_NOTIF_DRY_RUN="[DRY-RUN] Not Really Execute"
SUPPRESS='--no-messages'
QUIET='--quiet'
QUIET_MODE=
PACKAGE="$(echo "PACKAGE")"
PKG_SHARE_NENE="${HOME}/.local/share/nene/"
PKGS_INSTALLED="$PKG_SHARE_NENE/pkg-installed"
URL_CACHE="$PKG_SHARE_NENE/nene_last_url"
__BASE_REPO__="nene"
BASHER_PKG="${HOME}/.basher/cellar/packages/luisadha/${__BASE_REPO__}"
DRY_RUN=
DRY_RUN_PROMPT=
DEBUG=
MODE=
DB_FILE="$HOME/.local/share/nene/update-lists"
PROMPT="Choose a script to run online"
INSTALL="ALT-i: confirm to install this package"
REMOVE="ALT-r: confirm to remove this package"
ARTCODE_RAW=''
if_debug_mode() {
  case "${SETXVGLOBAL:-0}" in
    1|true|yes|on)
      set -xv
      ;;
    *)
      set +xv
      ;;
  esac
}
tenet() {
 exec 3>&1 4>&2 # backup stdout & stderr
  exec >/dev/null 2>&1
  ARTCODE_RAW=$1 # code yang dimanipulasi
  exec 1>&3 2>&4 # restore stdout & stderr
  exec 3>&- 4>&- # restore fd3 & fd4 ke file
}
artcode() {
  local src=${1:-'∅  (no artcode)'}

  printf '⟦ artcode :: raw memory ⟧\n'
  printf '\033]0;%s\007' "$src" |
    sed \
      -e 's/!/✗/g' \
      -e 's/</⟨/g' \
      -e 's/>/⟩/g' \
      -e 's/(/〔/g' \
      -e 's/)/〕/g' \
      -e 's/true/⊤/g' \
      -e 's/false/⊥/g' | tee >/dev/tty
}
pkg_in_dpkg() {
dpkg -s "$1" &>/dev/null
}
action_remove() {
dpkg -r "$pkg" || exit $?
sed -i "/^$pkg$/d" "$PKGS_INSTALLED"
echo "Package '${selected_pkg:-$pkg}' successfully removed."
}
pkg_in_nene() {
  grep -Fxq "$1" "$PKGS_INSTALLED"
}
html2text() {
  sed 's/\\\//\//g' \
  | grep -oiE 'https?://([^"'\'' ]+\.)?(github\.com|github\.io|raw\.githubusercontent\.com|gist\.github\.com)/[^"'\'' ]+' \
  | sort -u
}
ask_to_prompt() {
  local prompt="$1"
  local default="${2:-y}"

  # quiet mode → auto yes
  if [ "$QUIET_MODE" == "true" ]; then
    echo "$prompt [auto-$default]"
    return 0
  fi

  # non-interactive (pipe / CI)
  if ! [ -t 0 ]; then
    return 0
  fi

  read -rp "$prompt [y/N] " answer
  [[ "${answer:-$default}" =~ ^[Yy]$ ]]
}
available_options() {
cat <<'EOF' | awk '
{
    f1=$1; $1=""; sub(/^ /,"",$0)
    f2=$1; $1=""; sub(/^ /,"",$0)
    desc = $0
    if (length(f1)==1) {
        printf "-%-2s --%-17s %s\n", f1, f2, desc
    } else {
        gsub(/[[:space:]]+/, "-", f1)
        printf "    --%-12s %s\n", f1, desc
    }
}
'
u update                      Update local package repository data from the server.
s select-url                  Open the source page or website of each package, This option can also be combined with -c (copy: Copy selected a url into clipboard) or -o (open: mean open a selected url, Same as -s).
h help                        Display this help message and exit.
m mode-online=                Set data source: 1 for online packages, 0 for offline local packages, Both modes open the interactive menu interface.
v version                     Show program version information.
i install                     Install the selected package (auto-handles updates), This option can also be combined with -q (quiet: Suppress fzf output) or -n (dry-run).
I info-all                    Display detailed information about all available packages.
r remove                      Uninstall the selected packages from the system.
a api-termux                  Enable running Nene scripts directly from shared websites or URLs.
n dry-run                     No action; perform a simulation of events that would occur.
H homepage                    Open the official homepage of Nene.
d debug                       Enable debug mode. The program logs detailed diagnostic information and writes it to ~/nene-nohup.out.
V verbose enable verbosity output.
EOF
exit 0
}
mapfile -t FLAGS < <(available_options | xargs -d'\')
catch_any_error() {
  local code=$?
  local func=${FUNCNAME[1]:-main}
  local lastcmd=${BASH_COMMAND}
  printf "${DRY_RUN:-"[ERROR]"} ($func) Command '$lastcmd' failed with exit code $code\n" >/dev/tty >> ~/nene-nohup.out

  # Jika error dari curl, identifikasi kodenya
  if [[ $lastcmd == curl* ]]; then
    case $code in
      6)  msg="Couldn't resolve host" ;;
      7)  msg="Failed to connect to host" ;;
      28) msg="Operation timeout" ;;
      *)  msg="Other curl error ($code)" ;;
    esac
    echo "[CURL] $msg"
  fi
 return $code
}

check_connection() {
  curl -Is --connect-timeout 3 https://github.com >/dev/null 2>&1;
}
info_all_dpkg() {
while IFS= read -r pkg; do   dpkg -s "$pkg" 2>/dev/null;   echo    # baris kosong sebagai pemisah
done < "$PKG_SHARE_NENE"/pkg-installed
}
update_remote_db() {
  mkdir -p "$(dirname "$DB_FILE")"
  connect(){ if check_connection; then echo; else offline_status;       exit $?; fi; }; connect; unset -f connect;

  curl -s "$NEPI" \
    | html2text \
    | xargs -r -n1 basename > "$DB_FILE"

  if [ $? -eq 0 ] && [ -s "$DB_FILE" ]; then
    echo "✅ Remote database updated successfully."
    return 0
  else
    echo "❌ Failed to update remote database"
    return 1
  fi
}
checking_update() {
  local pkg=$1
curl -s https://api.github.com/repos/luisadha/$pkg/releases/latest | grep "browser_download_url.*\.deb"|cut -d '"' -f 4
}
default_apps() {
 if [[ -n "$BASHER_ROOT" && -d "$BASHER_PKG" ]]; then
    exec python3 "${BASHER_PKG}/not-echo-not-true.py"
    return 0
  else
    exec python3 "${PREFIX}/libexec/not-echo-not-true.py"
 fi
}
online_apps() {
    read -r __url__ < <(curl -s "$NEPI" |
    html2text |
    grep -oP '(?<=\])\(\K[^)]+' |
    grep '^https\?://' |
    grep -E 'github\.com|github\.io|luisadha\.my\.id' |
    sort -ur |
    awk '{print $0 "\t" gensub(".*/", "", "g", $0)}' |
    fzf --with-nth=2 --prompt="Choose (script): " --delimiter='\t');
    [ -z "$__url__" ] &&  echo -e "\nCaught ^" || . <(curl -sL $__url__);

}
fzf_walker() {

  connect=$(if check_connection; then echo; else offline_status; exit $?; fi);
    # hanya jalankan fzf kalau cache kosong
    if [[ -s "$URL_CACHE" ]]; then
        cat "$URL_CACHE"
    else
        local url
        url=$(curl -s "$NEPI" \
            | html2text \
            | fzf --ghost="$connect" --prompt="Indexing URL: ")
        echo "$url" > "$URL_CACHE"
        echo "$url"
    fi
}

select_url() {
    local cmd="${1:-echo}"
    local url

    url=$(fzf_walker)
    [[ -z "$url" ]] && return 1

    echo "$url" | xargs -r $cmd
}
homepage() {
echo "$NEPI" | xargs termux-open-url
    return 0
}
addon() {
echo -e "Creating file.. ~/bin/nene-ak47.sh"
cat <<'EOF' > "$HOME"/bin/nene-ak47.sh
# Nene-ak47 is receiver script for termux-url-opener to run many nene webapp script
# Copyright (C) 2025 Luis Adha under MIT License.
: "If you change this, you-
will not be able to run-
webapp-based Bash scripts-
through Android sharing until-
you change it back."
: "Jika anda mengganti ini-
anda tidak bisa menjalankan-
scirpt bash berbasis webapp-
melalui android berbagi-
sampai anda mengantinya lagi."
    url=$1
    curl -L "$url" | bash
    echo "Process completed."
    read wait
EOF
sleep 0.4;
echo "Installing.. "
cp -f ~/bin/nene-ak47.sh ~/bin/termux-url-opener
sleep 0.5
echo "..done"
return 0
}
show_help() {
echo -e "$SUMMARY\n"
echo -e "Usage: ${0##*/} [uhvIaHsco] [-ri(qn) ARGUMENT].."
echo -e "\t --mode-online=[n] --dry-run=[n] "
  echo
  echo "Options:"
  for f in "${FLAGS[@]}"; do
    IFS="|" read -r flag desc <<< "$f"
    printf "  %-18s %s\n" "$flag" "$desc"
  done
  exit 0
}
version() {
echo "nene v${VERSION}"
return 0
}

if [[ $# -eq 0 ]]; then
default_apps; # deprecreted
#nene --mode-online=0
exit 0
fi

if [[ "$1" == "-m" || "$1" == "--m" ]]; then
  echo -e "Invalid option, Did you means \`-m=1' ?";
    exit 1
fi

offline_status() {
   echo -e "No internet connections";
  return 6
}
error_exit_seconds ()
{
  echo "$DRY_RUN_PROMPT Deb file URL not found in release JSON. Check GitHub repository structure. (code: ${HTTP_STATUS:=404})";
return 1
}

while [[ $# -gt 0 ]]; do
 case "$1" in
    flags)
      available_options | sed -n 's/.*\(-[^ ]\+ \+\(--[^ ]\+\)\).*/\1/p' | xargs -d'\n'
      break;;
    -a|--api-termux)
      addon; shift;;
    -V|--verbose)
SETXVGLOBAL=1
      shift;;
    -s*|--select-url)
    opts="${1#-s}"
    [[ -z "$opts" ]] && opts="o"
    [[ "$1" == "--select-url" ]] && opts="o"

    url=$(fzf_walker)  # panggil sekali

    for opt in $(echo "$opts" | grep -o .); do
        case "$opt" in
            c)
                if [[ "$1" =~ ^-sc$ ]]; then
                echo "$url" | termux-clipboard-set
                [[ ! "$url" == "" ]] && termux-toast "Copied!"
                 break
                 # akhiri bagian sc meski gak ngefek, best practice aja
                fi
                ;;
            o)
                if [[ "$1" =~ ^-sco$ ]]; then
                termux-open-url "$url" &> /dev/null;
                [[ ! "$url" == "" ]] && termux-toast "Copied!"
                 break
                 # akhiri bagian sco supaya ga bocor ke s
                fi
                # back to parent s juga sama dengan o
                termux-open-url "$url" &> /dev/null;
                ;;
            *)
                echo -n # output kosong menandakan escape aman dan opsi -s dan --select-url bebas dari error
                ;;
        esac
    done

    # reset cache setelah semua operasi selesai
    : > "$URL_CACHE"
    shift
    ;;
    -h|--help)
      show_help; shift;;
    -v|--version)
      version; shift;;
   -H|--homepage)
      homepage; shift;;
    -d|--debug|--debug=1)
DEBUG=1; shift;;
    -n|--dry-run)
DRY_RUN=1; shift;;
    --dry-run=*)
DRY_RUN="${1#*=}"; [[ "$DRY_RUN" == "1" ]] && DRY_RUN=1 || DRY_RUN=0
#echo "DRY_RUN='${DRY_RUN}'"
export DRY_RUN_PROMPT="[DRY-RUN MODE]"; shift;;
    -u|--update)
      update_remote_db; shift ;;
    -I|--info-all)
      info_all_dpkg; shift;;
  -r*|--remove)
      [ -z "$2" ] && echo "Argument required for ${2:-"--remove"} <package>" && exit 2;
pkg=$2;
connect=$(if check_connection; then echo; else offline_status; exit $?; fi);
# 1️⃣ Tidak ada di dpkg
if ! pkg_in_dpkg "$pkg"; then
  # kalau ada di nene → hapus data yatim
  if pkg_in_nene "$pkg"; then
    sed -i "/^$pkg$/d" "$PKGS_INSTALLED"
    echo "Removed orphan entry '$pkg' from nene database."
  fi

  echo "Package '$pkg' not installed (dpkg)."
  exit 2
fi

# 2️⃣ Ada di dpkg tapi tidak ada di nene
if ! pkg_in_nene "$pkg"; then
  echo "Package '$pkg' exists in dpkg but not registered in nene."
  exit 2
fi
if [[ "$1" == *q* ]]; then
QUIET_MODE=true
else
QUIET_MODE=false
fi
  if [ ! "$QUIET_MODE" == "true" ]; then
# 3️⃣ BARU BOLEH MUNCUL UI
read -r key selected_pkg < <(
  printf "%s\n" "$pkg" |
  fzf --no-input --header-first \
    --header="ALT-r: confirm remove package" \
    --expect=alt-r \
    --bind="alt-r:accept"
)

[ "$key" != "alt-r" ] && {
  echo "Removal cancelled."
  exit 0
}
action_remove
else
action_remove
fi
      ;;
    -i*|--install) [ -z "$2" ] && echo "Argument required for ${2:-"--install"} <package>" && exit 1
      if [[ "$1" == *q* ]]; then
      if check_connection; then echo; else offline_status; exit $?; fi
      # kalau mengandung q juga, aktifkan quiet

QUIET_MODE=true
export FZF_DEFAULT_OPTS=(--bind="one:execute(tmpfile=\$(mktemp) && wget -O \"\$tmpfile\" {3} && dpkg -i \"\$tmpfile\" && rm -f \"\$tmpfile\" && exit)+abort" )
      else
QUIET_MODE=false
export FZF_DEFAULT_OPTS=(--bind="alt-i:execute(tmpfile=\$(mktemp) && wget -O \"\$tmpfile\" {3} && dpkg -i \"\$tmpfile\" && rm -f \"\$tmpfile\" && exit)+abort" )
      fi;
      if [[ "$1" == *n* ]]; then
DRY_RUN_MODE=true
__dry_run_ifi() {
  echo "$GLOBAL_NOTIF_DRY_RUN"
}
      else
DRY_RUN_MODE=false
      fi


      if [ "$QUIET_MODE" == "true" ]; then
SKIP_FZF_PROMPT="$FZF_DEFAULT_OPTS"
      else
SKIP_FZF_PROMPT="$FZF_DEFAULT_OPTS"
      fi
      if [ "$DRY_RUN_MODE" == "true" ]; then
unset FZF_DEFAULT_OPTS
SKIP_FZF_PROMPT=(-f=$pkg)
DRY_RUN_PROMPT="[DRY-RUN MODE]"
      fi

pkg="$2"
Package="$pkg"

  # Cek apakah paket sudah terpasang (ada di PATH)
  if command -v "$pkg" >/dev/null 2>&1; then
EXIST="true"
  else
EXIST="false"
  fi

  # Ambil versi terpasang (jika ada)
INSTALLED_VERSION=$(dpkg -s "$pkg" 2>/dev/null | awk '/Version/ {print $2}' | cut -d- -f1)

  # Ambil versi terbaru dari GitHub
API_URL="https://api.github.com/repos/luisadha/$pkg/releases/latest"
LATEST_JSON=$(curl -sSL "$API_URL")
LATEST_VERSION=$(echo "$LATEST_JSON" | jq -r .tag_name | sed 's/^v//')
LATEST_BODY=$(echo "$LATEST_JSON" | jq -r .body)

if [ "$EXIST" = true ]; then
    if [ "$LATEST_VERSION" = "null" ]; then
      echo "No release data found for $pkg."
      exit 1
    fi

  if dpkg -s "$pkg" >/dev/null 2>&1; then
      echo "$pkg" >> "$PKG_SHARE_NENE/pkg-installed"
      sort -u "$PKG_SHARE_NENE/pkg-installed" -o "$PKG_SHARE_NENE/pkg-installed"
      dpkg-query -W -f='${Package}\t${Description}\t' "$pkg"
    fi

  # Tentukan pesan aksi
  if [ "$INSTALLED_VERSION" = "$LATEST_VERSION" ]; then
    echo -ne "already up to date (v$INSTALLED_VERSION).\n"
      exit 0
    else
ASK_TO_ACTION="Would you like to upgrade?"
      echo -e "Current: $pkg $INSTALLED_VERSION"
      echo -e "Upgradeable: $pkg $LATEST_VERSION\n"
      echo -e "Changes:\n$LATEST_BODY\n"
    fi
  else
ASK_TO_ACTION="Would you like to install?"
    echo -e "$DRY_RUN_PROMPT Repository: $API_URL\n"
  fi


if ask_to_prompt "$DRY_RUN_PROMPT $ASK_TO_ACTION"; then
  __dry_run_ifi 2>/dev/null
else
  echo "Cancelled."
  exit 130
fi

  # Ambil file .deb terbaru
fetch_latest_deb=$(echo "$LATEST_JSON" | grep -o '"browser_download_url": *"[^"]*\.deb"' | cut -d '"' -f 4)

  # Validasi URL
HTTP_STATUS=$(curl -sSL -o /dev/null -w "%{http_code}" "$fetch_latest_deb" 2>/dev/null)
  if [ "$HTTP_STATUS" != "200" ] && [ "$HTTP_STATUS" != "302" ]; then
    exit 2
  fi

echo "$pkg" >> "$PKG_SHARE_NENE/pkg-installed"
sort -u "$PKG_SHARE_NENE/pkg-installed" -o "$PKG_SHARE_NENE/pkg-installed"

  # Pilih endpoint dan install
  read -r __url__ __endpoint__ < <(
    curl -s "${NEPI}" | \
      html2text | \
      awk -v rilis="$fetch_latest_deb" '{
        endpoint=gensub(".*/", "", "g", $0);
        full="https://luisadha.github.io/" endpoint;
        print full "\t" endpoint "\t" rilis;
      }' |
      fzf --no-input --header-first --with-nth=2 \
          --header="$INSTALL: " \
          --delimiter=$'\t' \
          "${SKIP_FZF_PROMPT}" -q ${pkg} );
      exit $?;
      ;;
    -m=1 | --mode-online=1) MODE="${1#*=}"
      shift;;
    -m=0 | --mode-online=0)  MODE="${1#*=}"
      shift;;
    *)
url_regex="^(https?|ftp)://[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(:[0-9]+)?(/.*)?$"

if [[ "$1" =~ $url_regex ]]; then
    curl -L "$1" | bash
    echo ""
    read -r -p "Process completed."
elif [[ "$1" == --* ]]; then
    # Opsi panjang
    echo "${UNKNOWN} : $1" >&2
elif [[ "$1" == -* ]]; then
    # Opsi pendek
    echo "${UNKNOWN} : $1" >&2
else
    echo "No valid URL or option provided."
fi
      shift;;
  esac
done
#shift $((OPTIND - 1))

if_debug_mode


__main__() { :; }
if [[ $DEBUG -eq 1 ]]; then
  pass() {
    ( termux-open ~/nene-nohup.out ) &
  }
else
  pass() {
    :;
  }
fi
__main_off () {
set -Eeo pipefail

if [[ $DEBUG -eq 1 ]]; then
trap catch_any_error ERR
{
  while IFS= read -r line; do
    printf '[%(%Y-%m-%d %H:%M:%S)T] %s\n' -1 "$line"
  done
} < <(
  grep -q . "$PKGS_INSTALLED" && return 1 || \
  cat "$PKGS_INSTALLED" |sort -ur|fzf -0|xargs -r bash 2>&1) >>~/nene-nohup.out
else
      if [[ ! -s "$PKGS_INSTALLED" ]]; then
        message="You haven't installed anything yet"
      else
        message=""
      fi
  cat "$PKGS_INSTALLED" | sort -ur | fzf --ghost="$message" | xargs -r bash | tee /dev/tty
fi

}
__main_on () {
set -Eo pipefail

trap catch_any_error ERR
data=$(
  curl -fsS "${NEPI}" 2>/dev/null \
  | html2text \
  | sort -ur \
  | awk '{
      endpoint=gensub(".*/", "", "g", $0)
      full="https://luisadha.github.io/" endpoint
      print full "\t" endpoint
    }'
)
# fzf bisa exit 130 kalau dibatalkan, maka periksa hasilnya
if [[ -z "$data" ]]; then
  err="[ERROR] Failed to fetch data from ${NEPI}"
fi

mapfile -t selection < <(
  printf "%s" "$data" \
  | fzf --ghost="$err" --with-nth=2 --prompt="$PROMPT: " --delimiter=$'\t' || {
      echo "[ERROR] User selection failed or canceled" >&2
      exit 1
    }
)

read -r __url__ __endpoint__ <<<"${selection[0]}"
if [[ -z "$__url__" || -z "$__endpoint__" ]]; then  
   echo "[ERROR] Empty URL or endpoint" >&2;
fi

if [[ $DEBUG -eq 1 ]]; then echo "[WARNING] Detailed debug are save at ~/nene-nohup.out" >&2;
   bash <(curl -sL "${__url__}") 2>&1 | ts '[%Y-%m-%d %H:%M:%S]' >> ~/nene-nohup.out 
fi

[[ -z "${selection[0]:-}" ]] && {
  echo "[INFO] No selection returned from fzf" >&2
  exit 1
}

bash <(curl -sL "${__url__}") 2>&1 | tee >/dev/tty
}
__dry_run_ifon()
{
  termux-toast "[DRY-RUN] Not Really Execute ${FUNCNAME[0]}()"
  tenet '!echo <(!true)' && artcode '!echo <(!true)'
}
__dry_run_ifof()
{
  local message="[DRY-RUN] Not Really Execute ${FUNCNAME[0]}()"
  printf '%s\n' "$message" >&2;
  termux-toast "$message"
  cat "$PKGS_INSTALLED" |sort -ur|fzf -0|xargs -r echo
}
__name__() {
function __main__() {
    case "$MODE" in
      1) __main_on; exit;;
      0) __main_off; exit;;
    esac
}
    case "$MODE-${DRY_RUN:-}" in
        0-1) __dry_run_ifof ;;
    0- |0-0) __main__ ;;
        1-1) __dry_run_ifon ;;
    1- |1-0) __main__ ;; #( set +Eeuo pipefail; curl -sL "${__url__}" | bash )
    esac
    unset -f __main__
}

: 'if'$(__name__)'=='$`__main__`:
  pass
