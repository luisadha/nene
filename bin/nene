#!/bin/sh
# WRAPPER: IMPORTANT DON'T CHANGE ANYTHING HERE

[ -z "$BASH_VERSION" ] && exec bash "$0" "$@"
unset HISTSIZE

__BASE_REPO__="nene"
__DIR__="${HOME}/.basher/cellar/packages/luisadha/${__BASE_REPO__}"


if [[ $# -eq 0 ]]; then
  mode="offline" 
fi

for arg in "$@"; do
  case "$arg" in
    -u|--select-url)
      mode="url"
      ;;
    -h|--help)
      mode="help"
      cat <<'EOF'
Nene is both a static site and a set of Bash tools you can run straight from your terminal
Usage :
  -u    --select-url    Select and open the link.
  -s    --select=[apps] Execute the explicitly specified application.
  -m    --mode=[online] Select and run through the link.
  -h    --help          Print this message.
EOF
      ;;
    m|--mode=*)
      MODE_ARG="${arg#--mode=}"
         M_ARG="${arg#--m=}"
      mode="online"
      ;;
    s|--select=*)
      SELECT_ARG="${arg#--select=}"
           S_ARG="${arg#--s=}
      mode="select"
      ;;
  esac
done

if [[ "$MODE_ARG" == "online" ]]; then
mode="online"
read url < <(
  curl -s https://not-echo-not-true.carrd.co |
    html2text |
    grep -oP '(?<=\])\(\K[^)]+' |
    grep '^https\?://' |
    grep -E 'github\.com|github\.io|luisadha\.my\.id' |
    sort -ur |
    awk '{print $0 "\t" gensub(".*/", "", "g", $0)}' |
    fzf --with-nth=2 --prompt="Choose (script): " --delimiter='\t')

[ -z "$url" ] && echo -e "\nCaught ^" || . <(curl -sL $url)
elif [[ "$MODE_ARG" == "default" ]]; then
mode="default"
elif [[ -n "$MODE_ARG" ]]; then
  echo -e "Invalid value, you mean \`--mode=online' ?"
  exit 3
fi

if [[ "$mode" == "default" || "$mode" == "offline" ]]; then
  exec python3 "${__DIR__}/not-echo-not-true.py"
elif [[ "$mode" == "url" ]]; then
  read _url_ < <(curl -s https://not-echo-not-true.carrd.co |
  html2text |
  grep -oP '(?<=\])\(\K[^)]+' |
  grep '^https\?://' |
  grep -E 'github\.com|github\.io|luisadha\.my\.id' |
  sort -ur | fzf --prompt="Choose URL: " |
  xargs -r termux-open-url);
elif [[ "$mode" == "select" ]]; then
  read __url__ __endpoint__ < <(
  curl -s https://not-echo-not-true.carrd.co 2>/dev/null |
    html2text |
    grep -oP '(?<=\])\(\K[^)]+' |
    grep '^https\?://' |
    grep -E 'github\.com|github\.io|luisadha\.my\.id' |
    sort -ur |
    awk '{print $0 "\t" gensub(".*/", "", "g", $0)}' |
    fzf --with-nth=2 --prompt="Choose (script): " --delimiter='\t' -q "$SELECT_ARG" -1 -0) || { echo "gagal"; } 
  echo -e "Executing.. $__endpoint__"
  . <(curl -sL $__url__ 2>/dev/null)
elif [[ "$mode" == "help" ]]; then
  : || exit 0
else
  echo -e "Invalid option."
  exit 1
fi
