#!/usr/bin/bash
#set -xv
# WRAPPER: IMPORTANT DON'T CHANGE ANYTHING HERE
[ -z "$BASH_VERSION" ] && exec bash "$0" "$@"

# shellcheck disable=SC1090
PACKAGE="nene"
VERSION="1.5.55b"
NEPI="luisadha.my.id" # formerly not-echo-not-true.carrd.co
V_FLAGS='--version' # GLOBAL FLAGS
E_MATCH='--exact' # FZF FLAGS
PACKAGE="$(echo "PACKAGE")"
PKG_SHARE_NENE="${HOME}/.local/share/nene/"
__BASE_REPO__="nene"
BASHER_PKG="${HOME}/.basher/cellar/packages/luisadha/${__BASE_REPO__}"


mkdir -p ${PKG_SHARE_NENE}
default_apps() {
 if [[ -n "$BASHER_ROOT" && -d "$BASHER_PKG" ]]; then
    exec python3 "${BASHER_PKG}/not-echo-not-true.py"
    return 0
  else
    exec python3 "${PREFIX}/libexec/not-echo-not-true.py"
 fi
}
check_dependencies() {
  local missing=()
  local dependencies=("python3" "jq" "termux-open-url" "sort" "xargs" "html2text" "fzf" "awk" "grep" "gum" "wget" "curl") 

  for cmd in "${dependencies[@]}"; do
    if ! command -v "$cmd" &>/dev/null; then
      missing+=("$cmd")
    fi
  done

  if (( ${#missing[@]} > 0 )); then
    echo "‚ùå Missing dependencies: ${missing[*]}"
    echo "üëâ Please install them and try again."
    exit 1
  fi
}
fetch_latest_version() {
local pkg="$1"
    curl -s https://api.github.com/repos/luisadha/${pkg}/releases |
jq -r 'sort_by(.published_at) | last | .tag_name'
    return 0
};
fetch_latest_date() {
local pkg="$1"
    curl -s https://api.github.com/repos/luisadha/${pkg}/releases \
  | jq -r 'max_by(.published_at).published_at[:10]'
   return 0
}
suggest() {
read -r __url__ __endpoint__ < <(
  curl -s https://not-echo-not-true.carrd.co 2>/dev/null |
  html2text |
  grep -oP '(?<=\])\(\K[^)]+' |
  grep '^https\?://' |
  grep -E 'github\.com|github\.io|luisadha\.my\.id' |
  sort -ur |
  awk '{print $0 "\t" gensub(".*/", "", "g", $0)}' |
  fzf --exact --with-nth=2 --prompt="Choose to Remove (script): " --delimiter='\t' -1 -0
)
echo "$__endpoint__"
}
online_apps() {
    read -r __url__ < <(curl -s https://not-echo-not-true.carrd.co |
    html2text |
    grep -oP '(?<=\])\(\K[^)]+' |
    grep '^https\?://' |
    grep -E 'github\.com|github\.io|luisadha\.my\.id' |
    sort -ur |
    awk '{print $0 "\t" gensub(".*/", "", "g", $0)}' |
    fzf --with-nth=2 --prompt="Choose (script): " --delimiter='\t');
    [ -z "$__url__" ] && echo -e "\nCaught ^"
# shellcheck disable=SC1090
    . <(curl -sL "$__url__")
   return 0
}
url() {
    read -r __url__ < <(curl -s https://not-echo-not-true.carrd.co | html2text | grep -oP '(?<=\])\(\K[^)]+' | grep '^https\?://' | grep -E 'github\.com|github\.io|luisadha\.my\.id' | sort -ur | fzf --prompt="Indexing URL: " | xargs -r termux-open-url);
    return 0
}
homepage() {
    termux-open-url https://not-echo-not-true.carrd.co
    return 0
}
addon() {
echo -e "Creating file.. ~/bin/nene-ak47.sh"
cat <<'EOF' > "$HOME"/bin/nene-ak47.sh
# Nene-ak47 is receiver script for termux-url-opener to run many nene webapp script
# Copyright (C) 2025 Luis Adha under MIT License.
: "If you change this, you-
will not be able to run-
webapp-based Bash scripts-
through Android sharing until-
you change it back."
: "Jika anda mengganti ini-
anda tidak bisa menjalankan-
scirpt bash berbasis webapp-
melalui android berbagi-
sampai anda mengantinya lagi."
    url=$1
    curl -L "$url" | bash
    echo "Process completed."
    read wait
EOF
sleep 0.4;
echo "..done"
return 0
}
available_options() {
cat <<'EOF'
-a
-u
-S
-Ss
-Si
-m
-v
-h
-R
--uninstall
--api-termux
--select-url
--homepage
--search
--mode
--version
--help
EOF
}
help() {
cat <<'EOF'
Nene is both a static site and a set of Bash tools you can run straight from your terminal
Usage :
  -a    --api-termux     Installs nene-ak47 to run Nene via WebApp using Android Share
  -u    --select-url     Select a webapp to open the link. This option is only effective when used after the -a option
        --homepage       Open homepage related this project
    -Ss PACKAGE          Search package metadata in JSON format
    -Si PACKAGE          Search and install the globally specified package
  -S    --search=PACKAGE Execute the explicitly specified application
  -m    --mode=online    Select and run through the link if not set default offline
  -v    --version        Print version script and exit
  -h    --help           Print this message and exit
EOF
}
version() {
echo "nene v${VERSION}"
return 0
}

if [[ $# -eq 0 ]]; then
default_apps;
fi

if [[ "$1" == "-s" || "$1" == "--s" ]]; then
  echo -e "Invalid option, you means \`-Ss' ?";
    exit 1
fi

for arg in "$@"; do
  case "$arg" in
    flags)
        available_options;;
    --homepage)
        homepage;;
    -a|--api-termux)
        addon;;
    -u|--select-url)
        url;;
    -h|--help)
        help;;
    -v|--version)
        version;;
   --mode|--mode=*)
          if [[ "$arg" == *=* ]]; then
            parse="$arg";
            #echo "$parse"
          else
            parse="${arg}=";
            #echo "$parse"
          fi;
MODE_ARG="${arg#--mode=}";
          if [[ -z "$MODE_ARG" ]]; then
echo -e "Invalid option, you mean \`${parse}online' ?";
exit 1;
          else
              SPARAM="$MODE_ARG";
             # echo "$SPARAM"
          fi;
modes="$SPARAM";
          if [[ "$modes" == "online" ]]; then
          online_apps;
          elif [[ "$modes" == "default" ]]; then
          default_apps;
          elif [[ "$modes" == "offline" ]]; then
          default_apps;
          else
          echo "Unknown value in $arg";
          exit 2;
          fi
        shift;
      ;;
    -m|-m=*)
          if [[ "$arg" == *=* ]]; then
            parse="$arg";
            #echo "$parse"
          else
            parse="${arg}=";
            #echo "$parse"
          fi;
M_ARG="${arg#-m=}";
          if [[ -z "$M_ARG" ]]; then
echo -e "Invalid option, you mean \`${parse}online' ?";
exit 1;
          else
              SPARAM="$M_ARG";
             # echo "$SPARAM"
          fi;
modes="$SPARAM";
          if [[ "$modes" == "online" ]]; then
          online_apps;
          elif [[ "$modes" == "default" ]]; then
          default_apps;
          elif [[ "$modes" == "offline" ]]; then
          default_apps;
          else
          echo "Unknown value in $arg";
          exit 2;
          fi
        shift;
      ;;
    --search=*)
                if [[ "$arg" == *=* ]]; then
                  parse="$arg";
                else
                  parse="${arg}=";
                fi;
SELECT_ARG="${arg#--search=}";
                if [[ -z "$SELECT_ARG" ]]; then
echo -e "Invalid option, you mean \`${parse}PACKAGE' ?";
exit 1;
                else
                    SPARAM="$SELECT_ARG";
                fi;
read -r __url__ __endpoint__ < <(curl -s https://not-echo-not-true.carrd.co 2>/dev/null | html2text | grep -oP '(?<=\])\(\K[^)]+' | grep '^https\?://' | grep -E 'github\.com|github\.io|luisadha\.my\.id' | sort -ur | awk '{print $0 "\t" gensub(".*/", "", "g", $0)}' | fzf ${E_MATCH} --with-nth=2 --prompt="Choose (script): " --delimiter='\t' -1 -0 -q "${SPARAM:-}"); [ -z "$SPARAM" ] && echo -e "\nCaught ^C" || echo -e "Executing.. $__endpoint__";
# shellcheck disable=SC1090
. <(curl -sL "$__url__" 2>/dev/null);
      shift;
        exit 0
      ;;
    -S=*)
                if [[ "$arg" == *=* ]]; then
                  parse="$arg";
                else
                  parse="${arg}=";
                fi;
S_ARG="${arg#-S=}";
                if [[ -z "$S_ARG" ]]; then
echo -e "Invalid option, you mean \`${parse}PACKAGE' ?";
exit 1;
                else
                    SPARAM="$S_ARG";
                fi;
read -r __url__ __endpoint__ < <(curl -s https://not-echo-not-true.carrd.co 2>/dev/null | html2text | grep -oP '(?<=\])\(\K[^)]+' | grep '^https\?://' | grep -E 'github\.com|github\.io|luisadha\.my\.id' | sort -ur | awk '{print $0 "\t" gensub(".*/", "", "g", $0)}' | fzf --with-nth=2 --prompt="Choose (script): " --delimiter='\t' -1 -0 -q "${SPARAM:-}"); [ -z "$SPARAM" ] && echo -e "\nCaught ^C" || echo -e "Executing.. $__endpoint__";
# shellcheck disable=SC1090
. <(curl -sL "$__url__" 2>/dev/null);
      shift;
        exit 0
      ;;
    -S|--search)
_S_ARG="$2";
                if [[ -z "$_S_ARG" ]]; then
echo -e "Error: option $arg request an argument $_S_ARG";
exit 1
                else                                                                   
SPARAM="$_S_ARG";
fi;
# shellcheck disable=SC1090
read -r __url__ __endpoint__ < <(curl -s https://not-echo-not-true.carrd.co 2>/dev/null | html2text | grep -oP '(?<=\])\(\K[^)]+' | grep '^https\?://' | grep -E 'github\.com|github\.io|luisadha\.my\.id' | sort -ur | awk '{print $0 "\t" gensub(".*/", "", "g", $0)}' | fzf ${E_MATCH} --with-nth=2 --prompt="Choose (script): " --delimiter='\t' -1 -0 -q "${SPARAM:-}"); [ -z "$SPARAM" ] && echo -e "\nCaught ^C" || echo -e "Executing.. $__endpoint__";
# shellcheck disable=SC1090
. <(curl -sL "$__url__" 2>/dev/null);
      shift;
        exit 0
      ;;
    -sS|-Ss)
      keyword="$2";
      
        if [ -z "$keyword" ]; then
          echo "Error: option -$arg request an argument"; exit 2;
        fi
      read -r url repo < <(curl -s https://not-echo-not-true.carrd.co 2>/dev/null | html2text | grep -oP '(?<=\])\(\K[^)]+' | grep '^https\?://' | grep -E 'github\.com|github\.io|luisadha\.my\.id' | sort -ur | awk '{print $0 "\t" gensub(".*/", "", "g", $0)}' | fzf ${E_MATCH} --with-nth=2 --prompt="Choose (script): " --delimiter='\t' -q "${keyword:-}" -1 -0)
        #echo "$url $repo"
      if [ -n "$keyword" ]; then
        curl -s "https://api.github.com/repos/luisadha/${repo}/contents/bin" > "${PKG_SHARE_NENE}"/"${repo}".json
        curl -s "https://api.github.com/repos/luisadha/${repo}/releases"  > "${PKG_SHARE_NENE}"/"${repo}"-release.json
        fetch_latest_version "${repo}"
        fetch_latest_date "${repo}"
        exit 0;
      else
        echo "‚ùå Can't find repository from $url"
        exit 1;
      fi
    ;;
    -R|--uninstall)
keyword="$2"
        if [ -z "$keyword" ]; then
          echo "Error: option -$arg requires an argument"; exit 2
        fi
  read -r url repo < <(
    curl -s https://not-echo-not-true.carrd.co 2>/dev/null | 
    html2text |
    grep -oP '(?<=\])\(\K[^)]+' |
    grep '^https\?://' |
    grep -E 'github\.com|github\.io|luisadha\.my\.id' |
    sort -ur |
    awk '{print $0 "\t" gensub(".*/", "", "g", $0)}' |
    fzf ${E_MATCH} --with-nth=2 --prompt="Choose (script): " --delimiter='\t' -q "${keyword:-}" -1 -0
  )

  if [ -n "$url" ] && [ -n "$repo" ]; then
      target="$PREFIX/bin"
      pkgname="$repo";
      mkdir -p "$target"
          pushd "$target" > /dev/null
    if [ -x "$repo" ]; then
        gum spin --spinner minidot --title "Unstalling ${repo}..." -- \
          rm -f "${repo}"
            if [ $? -eq 0 ]; then gum style --foreground 212 --bold "üóëÔ∏è Package ${repo} removed successfully"
            else gum style --foreground 196 --bold "‚ùå Failed to uninstall ${repo}."; fi;
    fi
          popd > /dev/null
  else
    gum log --level error "Can't find package named ${keyword}"
    exit 1
  fi
  exit 0
    ;;
    -Si|-iS)
      keyword="$2"
        if [ -z "$keyword" ]; then
          echo "Error: option -$arg requires an argument"; exit 2
        fi
  read -r url repo < <(
    curl -s https://not-echo-not-true.carrd.co 2>/dev/null | 
    html2text |
    grep -oP '(?<=\])\(\K[^)]+' |
    grep '^https\?://' |
    grep -E 'github\.com|github\.io|luisadha\.my\.id' |
    sort -ur |
    awk '{print $0 "\t" gensub(".*/", "", "g", $0)}' |
    fzf ${E_MATCH} --with-nth=2 --prompt="Choose (script): " --delimiter='\t' -q "${keyword:-}" -1 -0
  )

  if [ -n "$url" ] && [ -n "$repo" ]; then
    status=$(curl -s -o /dev/null -w "%{http_code}" "https://api.github.com/repos/luisadha/${repo}/contents/bin")
    if [ "$status" = "200" ]; then
      target="$PREFIX/bin"
      pkgname="$repo";
      IV="${pkgname} --version 2>/dev/null | cut -d' ' -f2"
      LV="$(fetch_latest_version ${pkgname})"
      mkdir -p "$target"
      pushd "$target" > /dev/null
      if [ ! -x "$repo" ]; then
        gum spin --spinner minidot --title "Installing ${repo}..." -- \
          wget --https-only -qO "${repo}" "${url}" && chmod +x "${repo}"
            if [ $? -eq 0 ]; then gum style --foreground 42 --bold "‚úÖ ${repo} was successfully installed!"
            else gum style --foreground 196 --bold "‚ùå Failed to install ${repo}."; fi;
      else     
        gum style --foreground 42 --bold "Package already installed: ${pkgname} in ${target}/${pkgname} ($(eval "${pkgname}" "$V_FLAGS"))"
      fi
      popd > /dev/null
    else
      gum log --level warn "${keyword}, the package is registered but cannot be installed yet (error code: ${status})"
      exit 1;
    fi
  else
    gum log --level error "Can't find package named ${keyword}"
    exit 1;
  fi
  exit 0
  ;;
    *)
     [ "$1" == "-R" || "$1" == "--uninstall" ] && suggest || echo "Error: Unknown options"
      exit 1;
    ;;
  esac
done
