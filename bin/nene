#!/usr/bin/bash
#set -xv
# WRAPPER: IMPORTANT DON'T CHANGE ANYTHING HERE
[ -z "$BASH_VERSION" ] && exec bash "$0" "$@"
# shellcheck disable=SC1090
PACKAGE="nene"
VERSION="1.5.67b"
NEPI="https://luisadha.my.id/" # formerly not-echo-not-true.carrd.co
V_FLAGS='--version' # GLOBAL FLAGS
E_MATCH='--exact' # FZF FLAGS
S_MATCH='--smart'
UNKNOWN="Error: Unknown options"
STARGS=1; 
NDARGS=2;
RDARGS=3;
THARGS=4;
NULLARGS=0;
SUPPRESS='--no-messages'
QUIET='--quiet'
PACKAGE="$(echo "PACKAGE")"
PKG_SHARE_NENE="${HOME}/.local/share/nene/"
__BASE_REPO__="nene"
BASHER_PKG="${HOME}/.basher/cellar/packages/luisadha/${__BASE_REPO__}"
DRY_RUN=0
MODE=0
DB_FILE="$HOME/.local/share/nene/update-lists"
PROMPT="Choose a script to run online"
INSTALL="CTRL-i: to install" 
REMOVE="CTRL-r: to remove packages"
info_all_dpkg() {
while IFS= read -r pkg; do   dpkg -s "$pkg" 2>/dev/null;   echo    # baris kosong sebagai pemisah
done < pkg-installed 
}
update_remote_db() {
  mkdir -p "$(dirname "$DB_FILE")"
  curl -s "$NEPI" \
    | html2text \
    | grep -oP '(?<=\])\(\K[^)]+' \
    | grep '^https\?://' \
    | grep -E 'github\.com|github\.io' \
    | xargs -r -n1 basename > "$DB_FILE"

  if [ $? -eq 0 ] && [ -s "$DB_FILE" ]; then
    echo "‚úÖ Remote database updated successfully."
    return 0
  else
    echo "‚ùå Failed to update remote database or file empty."
    return 1
  fi
}

default_apps() {
 if [[ -n "$BASHER_ROOT" && -d "$BASHER_PKG" ]]; then
    exec python3 "${BASHER_PKG}/not-echo-not-true.py"
    return 0
  else
    exec python3 "${PREFIX}/libexec/not-echo-not-true.py"
 fi
}
check_dependencies() {
  local missing=()
  local dependencies=("python3" "jq" "termux-open-url" "sort" "xargs" "html2text" "fzf" "awk" "grep" "gum" "wget" "curl") 

  for cmd in "${dependencies[@]}"; do
    if ! command -v "$cmd" &>/dev/null; then
      missing+=("$cmd")
    fi
  done

  if (( ${#missing[@]} > 0 )); then
    echo "‚ùå Missing dependencies: ${missing[*]}"
    echo "üëâ Please install them and try again."
    exit 1
  fi
}
online_apps() {
    read -r __url__ < <(curl -s "$NEPI" |
    html2text |
    grep -oP '(?<=\])\(\K[^)]+' |
    grep '^https\?://' |
    grep -E 'github\.com|github\.io|luisadha\.my\.id' |
    sort -ur |
    awk '{print $0 "\t" gensub(".*/", "", "g", $0)}' |
    fzf --with-nth=2 --prompt="Choose (script): " --delimiter='\t');
    [ -z "$__url__" ] &&  echo -e "\nCaught ^" || . <(curl -sL $__url__);
   
}
url() {
    read -r __url__ < <(curl -s "$NEPI" | html2text | grep -oP '(?<=\])\(\K[^)]+' | grep '^https\?://' | grep -E 'github\.com|github\.io' | sort -ur | fzf --prompt="Indexing URL: " | xargs -r termux-open-url);
    return 0
}
homepage() {
    termux-open-url https://luisadha.my.id
    return 0
}
addon() {
echo -e "Creating file.. ~/bin/nene-ak47.sh"
cat <<'EOF' > "$HOME"/bin/nene-ak47.sh
# Nene-ak47 is receiver script for termux-url-opener to run many nene webapp script
# Copyright (C) 2025 Luis Adha under MIT License.
: "If you change this, you-
will not be able to run-
webapp-based Bash scripts-
through Android sharing until-
you change it back."
: "Jika anda mengganti ini-
anda tidak bisa menjalankan-
scirpt bash berbasis webapp-
melalui android berbagi-
sampai anda mengantinya lagi."
    url=$1
    curl -L "$url" | bash
    echo "Process completed."
    read wait
EOF
sleep 0.4;
echo "..done"
return 0
}
_help() {
cat <<'EOF'
Nene is both a static site and a set of Bash tools you can run straight from your terminal
Usage :
  -a    --api-termux     Installs nene-ak47 to run Nene via WebApp using Android Share
  -u    --select-url     Select a webapp to open the link. This option is only effective when used after the -a option
        --homepage       Open homepage related this project
  -m    --mode=online    Select and run through the link if not set default offline
  -v    --version        Print version script and exit
  -h    --help           Print this message and exit
EOF
}
version() {
echo "nene v${VERSION}"
return 0
}

if [[ $# -eq 0 ]]; then
default_apps;
fi

if [[ "$1" == "-m" || "$1" == "--m" ]]; then
  echo -e "Invalid option, you means \`-m=1' ?";
    exit 1
fi

available_options() {
cat <<EOF
-a
-u 
-s
-h
-m
-v 
-u
-i
-I
-r
--info-all
--remove
--install
--update
--select-url
--api-termux
--dry-run
--help
--mode
--homepage
--version
EOF
}
offline_status() {
    echo -e "No internet connections" >&2;
    return 2
}
error_exit_seconds ()
{
  echo "Deb file URL not found in release JSON. Check GitHub repository structure. (code: ${HTTP_STATUS:=404})";
return 1
}
for arg in "$@"; do
  case "$arg" in
    flags)        available_options;;
    -a|--api-termux)    addon;;
    -s|--select-url)      url;;
    -h|--help)          _help;;
    -v|--version)        version;;
       --homepage)      homepage;;
       --dry-run | --dry-run=1) DRY_RUN=1;;
       --dry-run=*) echo "Value must be 1 in $arg" >&2; exit 2;;
    -u|--update)
      update_remote_db
      ;;
    -I|--info-all)
      info_all_dpkg
      ;;
    -r|--remove)
      export pkg=$2
if dpkg -s "$pkg" >/dev/null 2>&1; then
   # echo "Paket bisa dihapus"
    :
else
    sed -i "/^$pkg$/d" "$PKG_SHARE_NENE/pkg-installed"
    echo "Cannot remove this packages"
    exit 2
fi
    read -r __url__ __endpoint__ < <(curl -s "${NEPI}" | html2text | grep -oP '(?<=\])\(\K[^)]+' | grep '^https\?://' | grep -E 'github\.com|github\.io' | sort -ur | awk '{endpoint=gensub(".*/", "", "g", $0)
    full="https://luisadha.github.io/" endpoint
    print full "\t" endpoint                    }' | fzf -0 --with-nth=2 --prompt="$REMOVE: " --delimiter=$'\t' --bind="ctrl-r:execute(dpkg -r \"\$pkg\")+abort" -q ${pkg:-$__url__} ); [ -z "$2" ] && echo "Argument required $2";
         exit $?
         ;;
    -i|--install)
trap 'error_exit_seconds' ERR
[ -z "$2" ] && echo "Argument required $2" && exit 0
      export pkg=$2 
      export Package=$pkg
if dpkg -s "$pkg" >/dev/null 2>&1; then
    dpkg-query -W -f='${Package} ${Version}\n${Description}\n' "$pkg" 2>/dev/null
    echo "$Package" >> $PKG_SHARE_NENE/pkg-installed 
    sort -u $PKG_SHARE_NENE/pkg-installed -o $PKG_SHARE_NENE/pkg-installed
    pkg+=" ";
    exit
  else
    :
fi
  export fetch_latests_deb="$(curl -s https://api.github.com/repos/luisadha/$pkg/releases/latest | grep "browser_download_url.*\.deb"|cut -d '"' -f 4)"

export HTTP_STATUS="$(curl -s -o /dev/null -w "%{http_code}" "$fetch_latests_deb" 2>/dev/null)"

if [ "$HTTP_STATUS" == "200" ]; then
  echo
elif [ "$HTTP_STATUS" == "302" ]; then
  echo
else 
  error_exit_seconds;
  exit 2;
fi
trap - ERR
    read -r __url__ __endpoint__ < <(curl -s "${NEPI}" | html2text | grep -oP $SUPPRESS '(?<=\])\(\K[^)]+' | grep $SUPPRESS '^https\?://' | grep $SUPPRESS -E 'github\.com|github\.io' | sort -ur | awk -v rilis="$fetch_latests_deb" '{endpoint=gensub(".*/", "", "g", $0)
    full="https://luisadha.github.io/" endpoint
    print full "\t" endpoint "\t" rilis                       }' 2>/dev/null | fzf -0 --with-nth=2 --prompt="$INSTALL: " --delimiter=$'\t' --bind="ctrl-i:execute(
                tmpfile=\$(mktemp) && \
                wget -O \"\$tmpfile\" {3} && \
                dpkg -i \"\$tmpfile\" && \
                rm -f \"\$tmpfile\" && exit)+abort" -q ${pkg:-$__url__} ); exit 0
                ;;
    -m=1 | --mode-online=1)  MODE=1 
      trap 'offline_status' ERR
read -r __url__ __endpoint__ < <(curl -s "${NEPI}" \
| html2text \
| grep -oP '(?<=\])\(\K[^)]+' \
| grep '^https\?://' \
| grep -E 'github\.com|github\.io' \
| sort -ur \
| awk '{
    endpoint=gensub(".*/", "", "g", $0)
    full="https://luisadha.github.io/" endpoint
    print full "\t" endpoint
  }' | fzf -0 --with-nth=2 --prompt="$PROMPT: " --delimiter=$'\t'); [ -z "$__url__" ] && offline_status
      shift 2
      ;;    
    -m=0 | --mode-online=0)  MODE=0;;
    *) echo "${UNKNOWN}" >&2; exit 1;
    ;;
  esac
  shift
done

# --- Eksekusi setelah semua flag diparsing ---

if [[ $MODE -eq 1 ]]; then
  if [[ $DRY_RUN -eq 1 ]]; then
    echo "[DRY-RUN] Not Really Execute ${__endpoint__}" 
    echo <(true) 2>/dev/null; # Do nothing
  else
    echo
    . <(curl -sL ${__url__}) 
  fi
fi
